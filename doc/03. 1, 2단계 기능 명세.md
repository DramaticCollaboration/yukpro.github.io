<template>
  <q-page class="bg-grey-1 min-h-screen">
    <!-- í—¤ë” -->
    <div class="bg-primary text-white q-pa-md">
      <div class="row items-center justify-between">
        <div class="text-h5 text-weight-bold">ğŸ¥© Yukpro</div>
        <q-btn flat icon="menu" dense />
      </div>
      <div class="text-subtitle1 q-mt-xs">B2B ì¶•ì‚°ë¬¼ ìœ í†µ í”Œë«í¼</div>
    </div>

    <!-- PWA ì„¤ì¹˜ ë°°ë„ˆ (5ì´ˆ í›„ í‘œì‹œ) -->
    <transition name="slide-down">
      <div 
        v-if="showPWABanner" 
        class="bg-orange-2 text-orange-9 q-pa-sm text-center"
      >
        <q-icon name="download" class="q-mr-xs" />
        ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ì—¬ ë” í¸ë¦¬í•˜ê²Œ ì´ìš©í•˜ì„¸ìš”
        <q-btn 
          flat 
          dense 
          icon="close" 
          class="float-right" 
          @click="closePWABanner"
        />
      </div>
    </transition>

    <!-- ê²€ìƒ‰ -->
    <div class="q-pa-md">
      <q-input
        v-model="searchKeyword"
        placeholder="ìƒí’ˆì„ ê²€ìƒ‰í•´ë³´ì„¸ìš” (ì˜ˆ: í•œìš°, ë“±ì‹¬)"
        outlined
        bg-color="white"
        @keyup.enter="searchProducts"
      >
        <template v-slot:prepend>
          <q-icon name="search" />
        </template>
      </q-input>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
    <div class="q-pa-md">
      <q-tabs
        v-model="selectedCategory"
        dense
        class="text-grey"
        active-color="primary"
        indicator-color="primary"
        align="justify"
      >
        <q-tab name="beef" label="ì†Œ" />
        <q-tab name="pork" label="ë¼ì§€" />
        <q-tab name="chicken" label="ë‹­" />
      </q-tabs>
    </div>

    <!-- ì£¼ìš” ê¸°ëŠ¥ ì†Œê°œ -->
    <div class="q-pa-md">
      <div class="text-h6 q-mb-md">ì™œ Yukproì¸ê°€ìš”?</div>
      <div class="row q-gutter-md">
        <q-card class="col-12 col-sm-4">
          <q-card-section class="text-center">
            <q-icon name="scale" size="48px" color="primary" />
            <div class="text-subtitle1 q-mt-sm text-weight-bold">5kg ë‹¨ìœ„ ì†ŒëŸ‰ ì£¼ë¬¸</div>
            <div class="text-body2 text-grey-7">
              ëŒ€ëŸ‰ êµ¬ë§¤ ë¶€ë‹´ ì—†ì´<br>í•„ìš”í•œ ë§Œí¼ë§Œ ì£¼ë¬¸
            </div>
          </q-card-section>
        </q-card>

        <q-card class="col-12 col-sm-4">
          <q-card-section class="text-center">
            <q-icon name="verified" size="48px" color="green" />
            <div class="text-subtitle1 q-mt-sm text-weight-bold">ì‚¬ì—…ì ì¸ì¦</div>
            <div class="text-body2 text-grey-7">
              OCR ê¸°ë°˜ ìë™ ì¸ì¦<br>ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
            </div>
          </q-card-section>
        </q-card>

        <q-card class="col-12 col-sm-4">
          <q-card-section class="text-center">
            <q-icon name="local_shipping" size="48px" color="orange" />
            <div class="text-subtitle1 q-mt-sm text-weight-bold">ì‹¤ì‹œê°„ ë°°ì†¡ ì¶”ì </div>
            <div class="text-body2 text-grey-7">
              CJ ëŒ€í•œí†µìš´ ì—°ë™<br>ë°°ì†¡ ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸
            </div>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <!-- ì¸ê¸° ìƒí’ˆ -->
    <div class="q-pa-md">
      <div class="text-h6 q-mb-md">ì¸ê¸° ìƒí’ˆ</div>
      <div class="row q-gutter-md">
        <q-card 
          v-for="product in popularProducts" 
          :key="product.id"
          class="col-12 col-sm-6 cursor-pointer"
          @click="viewProduct(product.id)"
        >
          <q-img
            :src="product.image"
            ratio="4/3"
            class="rounded-borders"
          >
            <div class="absolute-bottom-right q-ma-xs">
              <q-chip dense color="primary" text-color="white">
                ìµœì†Œ 5kg
              </q-chip>
            </div>
          </q-img>
          <q-card-section>
            <div class="text-subtitle1 text-weight-bold">{{ product.name }}</div>
            <div class="text-h6 text-primary">{{ product.price.toLocaleString() }}ì›/kg</div>
            <div class="text-caption text-grey-7">{{ product.description }}</div>
          </q-card-section>
          <q-card-actions>
            <q-btn
              flat
              color="primary"
              label="ìƒì„¸ë³´ê¸°"
              @click.stop="viewProduct(product.id)"
            />
            <q-space />
            <q-btn
              color="primary"
              label="ì¥ë°”êµ¬ë‹ˆ"
              @click.stop="addToCart(product)"
              :disable="!isAuthenticated"
            />
          </q-card-actions>
        </q-card>
      </div>
    </div>

    <!-- ì–¸ë°•ì‹± ë¦¬ë·° ì„¹ì…˜ -->
    <div class="q-pa-md bg-grey-2">
      <div class="text-h6 q-mb-md">ê³ ê° ì–¸ë°•ì‹± ë¦¬ë·°</div>
      <div class="text-body2 text-grey-7 q-mb-md">
        ì‹¤ì œ êµ¬ë§¤ ê³ ê°ë“¤ì˜ ì–¸ë°•ì‹± ì˜ìƒê³¼ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”
      </div>
      <div class="row q-gutter-md">
        <q-card 
          v-for="review in unboxingReviews" 
          :key="review.id"
          class="col-12 col-sm-6"
        >
          <q-img
            :src="review.thumbnail"
            ratio="16/9"
            class="rounded-borders"
          >
            <div class="absolute-center">
              <q-btn 
                fab 
                color="white" 
                text-color="primary" 
                icon="play_arrow"
                @click="playReview(review.id)"
              />
            </div>
          </q-img>
          <q-card-section>
            <div class="text-subtitle2">{{ review.productName }}</div>
            <div class="text-caption text-grey-7">{{ review.customerName }} â€¢ {{ review.date }}</div>
            <div class="q-mt-sm">
              <q-chip 
                v-if="review.type === 'video'"
                dense 
                color="red" 
                text-color="white"
              >
                ì˜ìƒ ë¦¬ë·° +500P
              </q-chip>
              <q-chip 
                v-else
                dense 
                color="blue" 
                text-color="white"
              >
                ì´ë¯¸ì§€ ë¦¬ë·° +300P
              </q-chip>
            </div>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="fixed-bottom q-pa-md bg-white" style="box-shadow: 0 -2px 8px rgba(0,0,0,0.1)">
      <div class="row q-gutter-sm">
        <q-btn 
          v-if="!isAuthenticated"
          color="primary" 
          label="ì‚¬ì—…ì ì¸ì¦í•˜ê¸°"
          class="col"
          @click="goToRegister"
        />
        <template v-else>
          <q-btn 
            flat
            color="primary" 
            label="ì „ì²´ ìƒí’ˆ"
            class="col"
            @click="goToProducts"
          />
          <q-btn 
            color="primary" 
            label="ì£¼ë¬¸í•˜ê¸°"
            class="col"
            @click="goToCart"
          />
        </template>
      </div>
    </div>
  </q-page>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useQuasar } from 'quasar';

const router = useRouter();
const $q = useQuasar();

// ë°˜ì‘í˜• ë°ì´í„°
const searchKeyword = ref('');
const selectedCategory = ref('beef');
const showPWABanner = ref(false);
const isAuthenticated = ref(false); // ì‹¤ì œë¡œëŠ” storeì—ì„œ ê´€ë¦¬

// ì¸ê¸° ìƒí’ˆ ë°ì´í„°
const popularProducts = ref([
  {
    id: 1,
    name: 'í•œìš° ë“±ì‹¬',
    price: 85000,
    description: '1++ ë“±ê¸‰ í•œìš° ë“±ì‹¬, ë§ˆë¸”ë§ ìš°ìˆ˜',
    image: 'https://via.placeholder.com/400x300/FF6B6B/FFFFFF?text=í•œìš°+ë“±ì‹¬'
  },
  {
    id: 2,
    name: 'ë¼ì§€ ì‚¼ê²¹ì‚´',
    price: 15000,
    description: 'êµ­ë‚´ì‚° ì‹ ì„ í•œ ì‚¼ê²¹ì‚´',
    image: 'https://via.placeholder.com/400x300/4ECDC4/FFFFFF?text=ë¼ì§€+ì‚¼ê²¹ì‚´'
  }
]);

// ì–¸ë°•ì‹± ë¦¬ë·° ë°ì´í„°
const unboxingReviews = ref([
  {
    id: 1,
    productName: 'í•œìš° ë“±ì‹¬ 10kg',
    customerName: 'ê¹€ì‚¬ì¥ë‹˜',
    date: '2024.07.15',
    type: 'video',
    thumbnail: 'https://via.placeholder.com/400x225/FF6B6B/FFFFFF?text=ì–¸ë°•ì‹±+ì˜ìƒ'
  },
  {
    id: 2,
    productName: 'ë¼ì§€ ì‚¼ê²¹ì‚´ 5kg',
    customerName: 'ë°•ì…°í”„ë‹˜',
    date: '2024.07.18',
    type: 'image',
    thumbnail: 'https://via.placeholder.com/400x225/4ECDC4/FFFFFF?text=ì–¸ë°•ì‹±+ì´ë¯¸ì§€'
  }
]);

// ë©”ì„œë“œë“¤
const searchProducts = () => {
  if (searchKeyword.value.trim()) {
    router.push(`/search?q=${encodeURIComponent(searchKeyword.value)}`);
  }
};

const viewProduct = (productId: number) => {
  router.push(`/products/${productId}`);
};

const addToCart = (product: any) => {
  if (!isAuthenticated.value) {
    $q.notify({
      type: 'warning',
      message: 'ì‚¬ì—…ì ì¸ì¦ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤',
      actions: [
        {
          label: 'ì¸ì¦í•˜ê¸°',
          color: 'white',
          handler: () => goToRegister()
        }
      ]
    });
    return;
  }
  
  $q.notify({
    type: 'positive',
    message: `${product.name}ì´(ê°€) ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`,
    timeout: 2000
  });
};

const playReview = (reviewId: number) => {
  $q.notify({
    message: 'ì–¸ë°•ì‹± ë¦¬ë·° ì¬ìƒ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤',
    timeout: 2000
  });
};

const closePWABanner = () => {
  showPWABanner.value = false;
};

const goToRegister = () => {
  router.push('/auth/register');
};

const goToProducts = () => {
  router.push(`/products?category=${selectedCategory.value}`);
};

const goToCart = () => {
  router.push('/cart');
};

// ìƒëª…ì£¼ê¸°
onMounted(() => {
  // PWA ë°°ë„ˆ 5ì´ˆ í›„ í‘œì‹œ
  setTimeout(() => {
    showPWABanner.value = true;
  }, 5000);
  
  // ì‹¤ì œë¡œëŠ” í† í° í™•ì¸ ë¡œì§
  // isAuthenticated.value = !!localStorage.getItem('auth_token');
});
</script>

<style scoped>
.slide-down-enter-active,
.slide-down-leave-active {
  transition: all 0.3s ease;
}

.slide-down-enter-from,
.slide-down-leave-to {
  transform: translateY(-100%);
  opacity: 0;
}

.min-h-screen {
  min-height: calc(100vh - 120px);
  padding-bottom: 80px;
}
</style>
